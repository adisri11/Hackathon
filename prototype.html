<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioSpace Explorer - Quick Prototype</title>
    <link rel="stylesheet" href="stylesheet.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ BioSpace Explorer</h1>
            <p class="subtitle">Explore NASA Space Biology Publications</p>
        </header>

        <!-- Controls before data load -->
        <div class="controls" id="preLoadControls">
            <button onclick="loadData()">Load Data</button>
        </div>

        <div id="loading" class="loading">
            Click "Load Data" to start exploring 608 publications
        </div>

        <!-- Controls shown after data load -->
        <div class="controls" id="postLoadControls" style="display: none;">
            <input type="text" id="searchInput" placeholder="Search publications...">
            <select id="yearFilter">
                <option value="all">All Years</option>
            </select>
            <button onclick="exportResults()">Export Results</button>
        </div>

        <!-- Main content -->
        <div id="mainContent" class="main-content" style="display: none;">
            <div class="stats-panel">
                <div class="stat-box">
                    <h3>Total Publications</h3>
                    <div class="stat-number" id="totalCount">0</div>
                </div>
                <div class="stat-box">
                    <h3>Years Covered</h3>
                    <div class="stat-number" id="yearCount">0</div>
                </div>
                <div class="stat-box">
                    <h3>Publications by Year</h3>
                    <canvas id="yearChart"></canvas>
                    <div id="unknownCount" style="margin-top: 8px; font-style: italic;"></div>
                </div>
                <div class="stat-box">
                    <h3>Quick Insights</h3>
                    <div id="insights"></div>
                </div>
            </div>

            <div class="publications" id="publicationList"></div>

            <div class="chatbot-container">
                <h3>ü§ñ Ask the BioSpace AI</h3>
                <div id="chatWindow" class="chat-window"></div>
                <div class="chat-input">
                  <input type="text" id="chatMessage" placeholder="Ask about space biology..." />
                  <button onclick="sendMessage()">Send</button>
                </div>
              </div>              
        </div>
    </div>

    <script>
        let allPublications = [];
        let filteredPublications = [];
        let chart = null;

        async function loadData() {
            document.getElementById('loading').innerHTML = '‚è≥ Loading publications...';

            try {
                // Load CSV from GitHub
                const response = await fetch('https://raw.githubusercontent.com/jgalazka/SB_publications/refs/heads/main/SB_publication_PMC.csv');
                const csvText = await response.text();

                // Parse CSV
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        allPublications = results.data.map((row, index) => {
                            const title = row.Title || row.title || 'Untitled';
                            const url = row.URL || row.url || row['Link'] || '';

                            const yearMatch = title.match(/\b(20\d{2})\b/) || url.match(/\b(20\d{2})\b/);
                            const year = yearMatch ? yearMatch[1] : 'Unknown';
                            const keywords = extractKeywords(title);

                            return {
                                id: index,
                                title,
                                url,
                                year,
                                keywords
                            };
                        });

                        filteredPublications = [...allPublications];
                        populateYearFilter();
                        renderAll();

                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'grid';
                        document.getElementById('preLoadControls').style.display = 'none';
                        document.getElementById('postLoadControls').style.display = 'flex';
                    }
                });
            } catch (error) {
                document.getElementById('loading').innerHTML = '‚ùå Error loading data. Please try again.';
                console.error('Error:', error);
            }
        }

        function extractKeywords(text) {
            const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'as', 'into', 'through', 'during', 'before', 'after', 'above', 'below']);
            return text
                .toLowerCase()
                .match(/\b[a-z]+\b/g)
                ?.filter(word => word.length > 4 && !stopWords.has(word))
                .slice(0, 5) || [];
        }

        function renderAll() {
            renderStats();
            renderChart();
            renderPublications();
            generateInsights();
        }

        function renderStats() {
            document.getElementById('totalCount').textContent = filteredPublications.length;
            const years = new Set(filteredPublications.map(p => p.year).filter(y => y !== 'Unknown'));
            document.getElementById('yearCount').textContent = years.size;
        }

        function renderChart() {
            const yearCounts = {};
            let unknownCount = 0;
            filteredPublications.forEach(pub => {
                if (pub.year !== 'Unknown') {
                    yearCounts[pub.year] = (yearCounts[pub.year] || 0) + 1;
                } else {
                    unknownCount++;
                }
            });

            const sortedYears = Object.keys(yearCounts).sort();
            const counts = sortedYears.map(year => yearCounts[year]);

            const ctx = document.getElementById('yearChart');
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedYears,
                    datasets: [{
                        label: 'Publications',
                        data: counts,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 10 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            const unknownDiv = document.getElementById('unknownCount');
            unknownDiv.textContent = unknownCount > 0 
                ? `Publications with unknown year: ${unknownCount}` 
                : '';
        }

        async function renderPublications() {
            const listContainer = document.getElementById('publicationList');
            if (filteredPublications.length === 0) {
                listContainer.innerHTML = '<div class="pub-card"><p>No publications found matching your criteria.</p></div>';
                return;
            }

            listContainer.innerHTML = ""; // Clear before rendering

            for (const pub of filteredPublications) {
                const card = document.createElement("div");
                card.classList.add("pub-card");

                const summaryText = pub.summary || "‚è≥ Generating summary...";

                card.innerHTML = `
                    <div class="pub-title">${pub.title}</div>
                    <div style="margin: 10px 0;">
                        <span class="badge">${pub.year}</span>
                        ${pub.keywords.slice(0, 3).map(kw => `<span class="badge">${kw}</span>`).join('')}
                    </div>
                    <div class="pub-summary">${summaryText}</div>
                
                    <div class="pub-abstract" style="display:none;">Loading abstract...</div>
                    
                    <a href="${pub.url}" target="_blank" class="pub-link">Read Full Paper ‚Üí</a>
                `;

            card.addEventListener("click", async (e) => {
                // Ignore clicks on the "Read Full Paper" link
                if (e.target.classList.contains('pub-link')) return;
                
                const abstractDiv = card.querySelector(".pub-abstract");
                const isVisible = abstractDiv.style.display === "block";

                if (isVisible) {
                    abstractDiv.style.display = "none";
                    return;
                }

                abstractDiv.style.display = "block";

                if (!pub.abstract) {
                    abstractDiv.textContent = "‚è≥ Fetching abstract...";
                    pub.abstract = await fetchAbstractFromPMC(pub.url);
                }

                const abstractContent = pub.abstract || "No abstract found.";
                abstractDiv.innerHTML = ` <h4 style="margin-bottom: 6px;">Abstract</h4> <p>${abstractContent}</p>`;

                // Adding similar articles section
                abstractDiv.innerHTML += `
                    <div class="similar-articles" style="margin-top:10px;">
                        <em>Loading similar articles...</em>
                    </div>
                `;

                const similarDiv = abstractDiv.querySelector(".similar-articles");
                const similar = await fetchSimilarArticles(pub.url);
                if (similar.length > 0) {
                    similarDiv.innerHTML = `
                        <h4>üîó Similar Articles</h4>
                        <ul>
                            ${similar.map(a => {
                                const link = a.pmcid 
                                    ? `https://pmc.ncbi.nlm.nih.gov/articles/${a.pmcid}/`
                                    : `https://pubmed.ncbi.nlm.nih.gov/${a.pmid}/`;
                                return `<li><a href="${link}" target="_blank">${a.title}</a></li>`;
                            }).join('')}
                        </ul>
                    `;
                } else {
                    similarDiv.innerHTML = "<em>No similar articles found.</em>";
                }
        });

        listContainer.appendChild(card);

        if (!pub.summary) {
            const summaryDiv = card.querySelector(".pub-summary");
            const summary = await generateSummary(pub.title);
            pub.summary = summary;
            summaryDiv.textContent = summary;
        }
    }
}


       async function fetchAbstractFromPMC(url) {
            try {
                // Extract the PMC ID from the link (e.g., PMC7998608)
                const idMatch = url.match(/PMC\d+/);
                if (!idMatch) return "No PMC ID found in URL.";

                const pmcId = idMatch[0];

                // Europe PMC API endpoint for fetching abstracts
                const apiUrl = `https://www.ebi.ac.uk/europepmc/webservices/rest/${pmcId}/fullTextXML`;

                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const xmlText = await response.text();

                // Extract the abstract text from the XML
                const abstractMatch = xmlText.match(/<abstract[^>]*>([\s\S]*?)<\/abstract>/i);
                if (!abstractMatch) return "Abstract not found in XML.";

                // Clean up any XML tags inside
                const abstract = abstractMatch[1].replace(/<[^>]+>/g, '').trim();

                return abstract || "Abstract not found.";
            } catch (err) {
                console.error("PMC fetch failed:", err);
                return "Error fetching abstract.";
            }
        }

        // async function fetchSimilarArticles(url) {
        //     try {
        //         const idMatch = url.match(/PMC(\d+)/);
        //         if (!idMatch) return [];

        //         const pmcid = idMatch[1];
        //         const apiUrl = `https://www.ebi.ac.uk/europepmc/webservices/rest/PMC${pmcid}/similar`;

        //         const response = await fetch(apiUrl);
        //         const xmlText = await response.text();

        //         // Parse XML (Europe PMC returns XML by default)
        //         const parser = new DOMParser();
        //         const xmlDoc = parser.parseFromString(xmlText, "application/xml");
        //         const articles = Array.from(xmlDoc.querySelectorAll("resultList > result"))
        //             .slice(0, 5) // get top 5
        //             .map(node => ({
        //                 title: node.querySelector("title")?.textContent || "No title",
        //                 id: node.querySelector("id")?.textContent || "",
        //                 source: node.querySelector("source")?.textContent || "",
        //                 pmcid: node.querySelector("pmcid")?.textContent || "",
        //             }));

        //         return articles;
        //     } catch (err) {
        //         console.error("Error fetching similar articles:", err);
        //         return [];
        //     }
        // }

       async function fetchSimilarArticles(url) {
    try {
        const idMatch = url.match(/PMC(\d+)/);
        if (!idMatch) return [];

        const pmcid = `PMC${idMatch[1]}`;
        
        // Use Europe PMC's search API to find related articles
        const apiUrl = `https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=${encodeURIComponent(pmcid)}&resultType=core&pageSize=6&format=json`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        
        // Get the first result (the article itself) to extract keywords for better search
        const mainArticle = data.resultList?.result?.[0];
        if (!mainArticle) return [];
        
        // Search for articles with similar keywords
        const keywords = mainArticle.keywordList?.keyword?.slice(0, 3).join(' OR ') || mainArticle.title?.split(' ').slice(0, 5).join(' ');
        const similarUrl = `https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=${encodeURIComponent(keywords)}&pageSize=6&format=json`;
        
        const similarResponse = await fetch(similarUrl);
        const similarData = await similarResponse.json();
        
        // Filter out the original article and return up to 5 similar ones
        const articles = (similarData.resultList?.result || [])
            .filter(article => article.pmcid && article.pmcid !== pmcid)
            .slice(0, 5)
            .map(article => ({
                title: article.title || "No title",
                pmcid: article.pmcid,
                pmid: article.pmid || null
            }));

        return articles;
    } catch (err) {
        console.error("Error fetching similar articles:", err);
        return [];
    }
}
        

        function populateYearFilter() {
            const years = [...new Set(allPublications.map(p => p.year).filter(y => y !== 'Unknown'))].sort().reverse();
            const select = document.getElementById('yearFilter');
            select.innerHTML = '<option value="all">All Years</option>' +
                years.map(year => `<option value="${year}">${year}</option>`).join('');
        }

        function setYearFilter(year) {
            const yearFilter = document.getElementById('yearFilter');
            yearFilter.value = year; 

            const displayDiv = document.getElementById('selectedYearDisplay');
            displayDiv.textContent = year === 'all'
                ? 'Showing publications for: All Years'
                : `Showing publications for: ${year}`;

            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            applyFilters(searchQuery, year);
        }

        function generateInsights() {
            const insightsDiv = document.getElementById('insights');
            const keywordCounts = {};
            filteredPublications.forEach(pub => {
                pub.keywords.forEach(kw => {
                    keywordCounts[kw] = (keywordCounts[kw] || 0) + 1;
                });
            });

            const topKeywords = Object.entries(keywordCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const yearCounts = {};
            filteredPublications.forEach(pub => {
                if (pub.year !== 'Unknown') {
                    yearCounts[pub.year] = (yearCounts[pub.year] || 0) + 1;
                }
            });

            const years = Object.keys(yearCounts).sort();
            const avgPerYear = filteredPublications.length / years.length;

            insightsDiv.innerHTML = `
                <p><strong>üìö Top Research Topics:</strong></p>
                <ul>
                    ${topKeywords.map(([kw, count]) => `<li>${kw}: ${count} papers</li>`).join('')}
                </ul>
                <p><strong>üìä Avg Publications/Year:</strong> ${Math.round(avgPerYear)}</p>
                <p><strong>üìà Peak Year:</strong> ${Object.entries(yearCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A'}</p>
            `;
        }

        const HF_API_TOKEN = "token"; // token
        const HF_SUMMARY_MODEL = "google/pegasus-xsum";

        async function generateSummary(text) {
            try {
                const response = await fetch(`https://api-inference.huggingface.co/models/${HF_SUMMARY_MODEL}`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${HF_API_TOKEN}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        inputs: text,
                        parameters: { max_length: 120, min_length: 30 }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HF API error: ${response.status}`);
                }

                const data = await response.json();
                return data[0]?.summary_text || "No summary available.";
            } catch (err) {
                console.error("Summarization error:", err);
                return "Error generating summary.";
            }
        }


        // Filtering
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            applyFilters(query, document.getElementById('yearFilter').value);
        });

        document.getElementById('yearFilter').addEventListener('change', (e) => {
            const query = document.getElementById('searchInput').value.toLowerCase();
            applyFilters(query, e.target.value);
        });

        function applyFilters(searchQuery, yearFilter) {
            filteredPublications = allPublications.filter(pub => {
                const matchesSearch = !searchQuery || 
                    pub.title.toLowerCase().includes(searchQuery) ||
                    pub.keywords.some(kw => kw.includes(searchQuery));

                const matchesYear = yearFilter === 'all' || pub.year === yearFilter;
                return matchesSearch && matchesYear;
            });

            renderAll();
        }

        function exportResults() {
            const csv = Papa.unparse(filteredPublications);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'biospace_export.csv';
            a.click();
        }

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });

        console.log('BioSpace Explorer Ready! Click "Load Data" to begin.');
        console.log('Keyboard shortcut: Ctrl+K to focus search');
    </script>
    
</body>
</html>

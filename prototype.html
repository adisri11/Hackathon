<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioSpace Explorer - Quick Prototype</title>
    <link rel="stylesheet" href="stylesheet.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸš€ BioSpace Explorer</h1>
            <p class="subtitle">Explore NASA Space Biology Publications</p>
        </header>

        <!-- Controls before data load -->
        <div class="controls" id="preLoadControls">
            <button onclick="loadData()">Load Data</button>
        </div>

        <div id="loading" class="loading">
            Click "Load Data" to start exploring 608 publications
        </div>

        <!-- Controls shown after data load -->
        <div class="controls" id="postLoadControls" style="display: none;">
            <input type="text" id="searchInput" placeholder="Search publications...">
            <select id="yearFilter">
                <option value="all">All Years</option>
            </select>
            <button onclick="exportResults()">Export Results</button>
        </div>

        <!-- Main content -->
        <div id="mainContent" class="main-content" style="display: none;">
            <div class="stats-panel">
                <div class="stat-box">
                    <h3>Total Publications</h3>
                    <div class="stat-number" id="totalCount">0</div>
                </div>
                <div class="stat-box">
                    <h3>Years Covered</h3>
                    <div class="stat-number" id="yearCount">0</div>
                </div>
                <div class="stat-box">
                    <h3>Publications by Year</h3>
                    <canvas id="yearChart"></canvas>
                    <div id="unknownCount" style="margin-top: 8px; font-style: italic;"></div>
                </div>
                <div class="stat-box">
                    <h3>Quick Insights</h3>
                    <div id="insights"></div>
                </div>
            </div>

            <div class="publications" id="publicationList"></div>
        </div>
    </div>

    <script>
        let allPublications = [];
        let filteredPublications = [];
        let chart = null;

        async function loadData() {
            document.getElementById('loading').innerHTML = 'â³ Loading publications...';

            try {
                // Load CSV from GitHub
                const response = await fetch('https://raw.githubusercontent.com/jgalazka/SB_publications/refs/heads/main/SB_publication_PMC.csv');
                const csvText = await response.text();

                // Parse CSV
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        allPublications = results.data.map((row, index) => {
                            const title = row.Title || row.title || 'Untitled';
                            const url = row.URL || row.url || row['PMC Link'] || '';

                            const yearMatch = title.match(/\b(20\d{2})\b/) || url.match(/\b(20\d{2})\b/);
                            const year = yearMatch ? yearMatch[1] : 'Unknown';
                            const keywords = extractKeywords(title);

                            return {
                                id: index,
                                title,
                                url,
                                year,
                                keywords
                            };
                        });

                        filteredPublications = [...allPublications];
                        populateYearFilter();
                        renderAll();

                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'grid';
                        document.getElementById('preLoadControls').style.display = 'none';
                        document.getElementById('postLoadControls').style.display = 'flex';
                    }
                });
            } catch (error) {
                document.getElementById('loading').innerHTML = 'âŒ Error loading data. Please try again.';
                console.error('Error:', error);
            }
        }

        function extractKeywords(text) {
            const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'as', 'into', 'through', 'during', 'before', 'after', 'above', 'below']);
            return text
                .toLowerCase()
                .match(/\b[a-z]+\b/g)
                ?.filter(word => word.length > 4 && !stopWords.has(word))
                .slice(0, 5) || [];
        }

        function renderAll() {
            renderStats();
            renderChart();
            renderPublications();
            generateInsights();
        }

        function renderStats() {
            document.getElementById('totalCount').textContent = filteredPublications.length;
            const years = new Set(filteredPublications.map(p => p.year).filter(y => y !== 'Unknown'));
            document.getElementById('yearCount').textContent = years.size;
        }

        function renderChart() {
            const yearCounts = {};
            let unknownCount = 0;
            filteredPublications.forEach(pub => {
                if (pub.year !== 'Unknown') {
                    yearCounts[pub.year] = (yearCounts[pub.year] || 0) + 1;
                } else {
                    unknownCount++;
                }
            });

            const sortedYears = Object.keys(yearCounts).sort();
            const counts = sortedYears.map(year => yearCounts[year]);

            const ctx = document.getElementById('yearChart');
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedYears,
                    datasets: [{
                        label: 'Publications',
                        data: counts,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 10 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            const unknownDiv = document.getElementById('unknownCount');
            unknownDiv.textContent = unknownCount > 0 
                ? `Publications with unknown year: ${unknownCount}` 
                : '';
        }

        function renderPublications() {
            const listContainer = document.getElementById('publicationList');
            if (filteredPublications.length === 0) {
                listContainer.innerHTML = '<div class="pub-card"><p>No publications found matching your criteria.</p></div>';
                return;
            }

            listContainer.innerHTML = filteredPublications.map(pub => `
                <div class="pub-card">
                    <div class="pub-title">${pub.title}</div>
                    <div style="margin: 10px 0;">
                        <span class="badge">${pub.year}</span>
                        ${pub.keywords.slice(0, 3).map(kw => `<span class="badge">${kw}</span>`).join('')}
                    </div>
                    <a href="${pub.url}" target="_blank" class="pub-link">Read Full Paper â†’</a>
                </div>
            `).join('');
        }

        function populateYearFilter() {
            const years = [...new Set(allPublications.map(p => p.year).filter(y => y !== 'Unknown'))].sort().reverse();
            const select = document.getElementById('yearFilter');
            select.innerHTML = '<option value="all">All Years</option>' +
                years.map(year => `<option value="${year}">${year}</option>`).join('');
        }

        function setYearFilter(year) {
            const yearFilter = document.getElementById('yearFilter');
            yearFilter.value = year; 

            const displayDiv = document.getElementById('selectedYearDisplay');
            displayDiv.textContent = year === 'all'
                ? 'Showing publications for: All Years'
                : `Showing publications for: ${year}`;

            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            applyFilters(searchQuery, year);
        }

        function generateInsights() {
            const insightsDiv = document.getElementById('insights');
            const keywordCounts = {};
            filteredPublications.forEach(pub => {
                pub.keywords.forEach(kw => {
                    keywordCounts[kw] = (keywordCounts[kw] || 0) + 1;
                });
            });

            const topKeywords = Object.entries(keywordCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const yearCounts = {};
            filteredPublications.forEach(pub => {
                if (pub.year !== 'Unknown') {
                    yearCounts[pub.year] = (yearCounts[pub.year] || 0) + 1;
                }
            });

            const years = Object.keys(yearCounts).sort();
            const avgPerYear = filteredPublications.length / years.length;

            insightsDiv.innerHTML = `
                <p><strong>ðŸ“š Top Research Topics:</strong></p>
                <ul>
                    ${topKeywords.map(([kw, count]) => `<li>${kw}: ${count} papers</li>`).join('')}
                </ul>
                <p><strong>ðŸ“Š Avg Publications/Year:</strong> ${Math.round(avgPerYear)}</p>
                <p><strong>ðŸ“ˆ Peak Year:</strong> ${Object.entries(yearCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A'}</p>
            `;
        }

        // Filtering
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            applyFilters(query, document.getElementById('yearFilter').value);
        });

        document.getElementById('yearFilter').addEventListener('change', (e) => {
            const query = document.getElementById('searchInput').value.toLowerCase();
            applyFilters(query, e.target.value);
        });

        function applyFilters(searchQuery, yearFilter) {
            filteredPublications = allPublications.filter(pub => {
                const matchesSearch = !searchQuery || 
                    pub.title.toLowerCase().includes(searchQuery) ||
                    pub.keywords.some(kw => kw.includes(searchQuery));

                const matchesYear = yearFilter === 'all' || pub.year === yearFilter;
                return matchesSearch && matchesYear;
            });

            renderAll();
        }

        function exportResults() {
            const csv = Papa.unparse(filteredPublications);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'biospace_export.csv';
            a.click();
        }

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });

        console.log('BioSpace Explorer Ready! Click "Load Data" to begin.');
        console.log('Keyboard shortcut: Ctrl+K to focus search');
    </script>
</body>
</html>

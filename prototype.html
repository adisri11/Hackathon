<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioSpace Explorer - With AI Chatbot</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        input[type="text"], select {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.5em;
            color: #667eea;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            padding: 20px;
        }

        .stats-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stat-box {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
        }

        .stat-box h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: #333;
        }

        .publications {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 800px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .pub-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
        }

        .pub-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .pub-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .pub-summary {
            color: #666;
            font-size: 0.95em;
            line-height: 1.6;
            margin: 10px 0;
            font-style: italic;
        }

        .badge {
            display: inline-block;
            background: #e8eaf6;
            color: #667eea;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-right: 8px;
            margin-bottom: 5px;
        }

        .pub-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            display: inline-block;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .pub-link:hover {
            color: #764ba2;
            transform: translateX(5px);
        }

        .chatbot-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
            transition: all 0.3s;
            z-index: 1000;
        }

        .chatbot-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.7);
        }

        .chatbot-container {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
        }

        .chatbot-container.active {
            display: flex;
        }

        .chatbot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-header h3 {
            font-size: 1.3em;
        }

        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.bot {
            flex-direction: row;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.user .message-avatar {
            background: #e0e0e0;
            color: #666;
        }

        .message-content {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 15px;
            line-height: 1.5;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chatbot-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .chatbot-input-area input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
        }

        .chatbot-input-area input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 10px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: bounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-action-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .paper-reference {
            background: #f0f0f0;
            border-left: 3px solid #667eea;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .paper-reference strong {
            color: #667eea;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .chatbot-container {
                width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🚀 BioSpace Explorer</h1>
            <p class="subtitle">Explore NASA Space Biology Publications with AI Assistant</p>
        </header>

        <div class="controls" id="preLoadControls">
            <button onclick="loadData()">Load Data</button>
        </div>

        <div id="loading" class="loading">
            Click "Load Data" to start exploring 608 publications
        </div>

        <div class="controls" id="postLoadControls" style="display: none;">
            <input type="text" id="searchInput" placeholder="Search publications...">
            <select id="yearFilter">
                <option value="all">All Years</option>
            </select>
            <button onclick="exportResults()">Export Results</button>
        </div>

        <div id="mainContent" class="main-content" style="display: none;">
            <div class="stats-panel">
                <div class="stat-box">
                    <h3>Total Publications</h3>
                    <div class="stat-number" id="totalCount">0</div>
                </div>
                <div class="stat-box">
                    <h3>Years Covered</h3>
                    <div class="stat-number" id="yearCount">0</div>
                </div>
                <div class="stat-box">
                    <h3>Publications by Year</h3>
                    <canvas id="yearChart"></canvas>
                    <div id="unknownCount" style="margin-top: 8px; font-style: italic;"></div>
                </div>
                <div class="stat-box">
                    <h3>Quick Insights</h3>
                    <div id="insights"></div>
                </div>
            </div>

            <div class="publications" id="publicationList"></div>
        </div>
    </div>

    <button class="chatbot-button" onclick="toggleChatbot()">💬</button>
    
    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-header">
            <h3>🤖 BioSpace Assistant</h3>
            <button class="close-btn" onclick="toggleChatbot()">×</button>
        </div>
        <div class="chatbot-messages" id="chatMessages"></div>
        <div class="chatbot-input-area">
            <input type="text" id="chatInput" placeholder="Ask me anything about the publications..." onkeypress="handleKeyPress(event)">
            <button class="send-btn" onclick="sendMessage()">➤</button>
        </div>
    </div>

    <script>
        let allPublications = [];
        let filteredPublications = [];
        let chart = null;
        let chatHistory = [];
        let paperContentCache = {};

        const HF_API_TOKEN = "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";
        const HF_QA_MODEL = "deepset/roberta-base-squad2";

        async function loadData() {
            document.getElementById('loading').innerHTML = '⏳ Loading publications...';

            try {
                const response = await fetch('https://raw.githubusercontent.com/jgalazka/SB_publications/refs/heads/main/SB_publication_PMC.csv');
                const csvText = await response.text();

                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        allPublications = results.data.map((row, index) => {
                            const title = row.Title || row.title || 'Untitled';
                            const url = row.URL || row.url || row['Link'] || '';
                            const yearMatch = title.match(/\b(20\d{2})\b/) || url.match(/\b(20\d{2})\b/);
                            const year = yearMatch ? yearMatch[1] : 'Unknown';
                            const keywords = extractKeywords(title);

                            return { id: index, title, url, year, keywords };
                        });

                        filteredPublications = [...allPublications];
                        populateYearFilter();
                        renderAll();

                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'grid';
                        document.getElementById('preLoadControls').style.display = 'none';
                        document.getElementById('postLoadControls').style.display = 'flex';

                        addBotMessage("👋 Hi! I'm your BioSpace Assistant with enhanced AI capabilities. I can now analyze paper content and answer detailed questions about the research! Try asking specific questions about topics in the papers.");
                        showQuickActions();
                    }
                });
            } catch (error) {
                document.getElementById('loading').innerHTML = '❌ Error loading data. Please try again.';
                console.error('Error:', error);
            }
        }

        function extractKeywords(text) {
            const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'as', 'into', 'through', 'during', 'before', 'after', 'above', 'below']);
            return text.toLowerCase().match(/\b[a-z]+\b/g)?.filter(word => word.length > 4 && !stopWords.has(word)).slice(0, 5) || [];
        }

        function renderAll() {
            renderStats();
            renderChart();
            renderPublications();
            generateInsights();
        }

        function renderStats() {
            document.getElementById('totalCount').textContent = filteredPublications.length;
            const years = new Set(filteredPublications.map(p => p.year).filter(y => y !== 'Unknown'));
            document.getElementById('yearCount').textContent = years.size;
        }

        function renderChart() {
            const yearCounts = {};
            let unknownCount = 0;
            filteredPublications.forEach(pub => {
                if (pub.year !== 'Unknown') {
                    yearCounts[pub.year] = (yearCounts[pub.year] || 0) + 1;
                } else {
                    unknownCount++;
                }
            });

            const sortedYears = Object.keys(yearCounts).sort();
            const counts = sortedYears.map(year => yearCounts[year]);

            const ctx = document.getElementById('yearChart');
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedYears,
                    datasets: [{
                        label: 'Publications',
                        data: counts,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 10 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            const unknownDiv = document.getElementById('unknownCount');
            unknownDiv.textContent = unknownCount > 0 ? `Publications with unknown year: ${unknownCount}` : '';
        }

        function renderPublications() {
            const listContainer = document.getElementById('publicationList');
            if (filteredPublications.length === 0) {
                listContainer.innerHTML = '<div class="pub-card"><p>No publications found matching your criteria.</p></div>';
                return;
            }

            listContainer.innerHTML = filteredPublications.slice(0, 50).map(pub => `
                <div class="pub-card">
                    <div class="pub-title">${pub.title}</div>
                    <div style="margin: 10px 0;">
                        <span class="badge">${pub.year}</span>
                        ${pub.keywords.slice(0, 3).map(kw => `<span class="badge">${kw}</span>`).join('')}
                    </div>
                    <a href="${pub.url}" target="_blank" class="pub-link">Read Full Paper →</a>
                </div>
            `).join('');

            if (filteredPublications.length > 50) {
                listContainer.innerHTML += `<div class="pub-card"><p style="text-align: center; color: #667eea;">Showing first 50 of ${filteredPublications.length} publications. Use filters to narrow results.</p></div>`;
            }
        }

        function populateYearFilter() {
            const years = [...new Set(allPublications.map(p => p.year).filter(y => y !== 'Unknown'))].sort().reverse();
            const select = document.getElementById('yearFilter');
            select.innerHTML = '<option value="all">All Years</option>' + years.map(year => `<option value="${year}">${year}</option>`).join('');
        }

        function generateInsights() {
            const insightsDiv = document.getElementById('insights');
            const keywordCounts = {};
            filteredPublications.forEach(pub => {
                pub.keywords.forEach(kw => {
                    keywordCounts[kw] = (keywordCounts[kw] || 0) + 1;
                });
            });

            const topKeywords = Object.entries(keywordCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const yearCounts = {};
            filteredPublications.forEach(pub => {
                if (pub.year !== 'Unknown') {
                    yearCounts[pub.year] = (yearCounts[pub.year] || 0) + 1;
                }
            });

            const years = Object.keys(yearCounts).sort();
            const avgPerYear = filteredPublications.length / years.length;

            insightsDiv.innerHTML = `
                <p><strong>📚 Top Research Topics:</strong></p>
                <ul>${topKeywords.map(([kw, count]) => `<li>${kw}: ${count} papers</li>`).join('')}</ul>
                <p><strong>📊 Avg Publications/Year:</strong> ${Math.round(avgPerYear)}</p>
                <p><strong>📈 Peak Year:</strong> ${Object.entries(yearCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A'}</p>
            `;
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            applyFilters(query, document.getElementById('yearFilter').value);
        });

        document.getElementById('yearFilter').addEventListener('change', (e) => {
            const query = document.getElementById('searchInput').value.toLowerCase();
            applyFilters(query, e.target.value);
        });

        function applyFilters(searchQuery, yearFilter) {
            filteredPublications = allPublications.filter(pub => {
                const matchesSearch = !searchQuery || pub.title.toLowerCase().includes(searchQuery) || pub.keywords.some(kw => kw.includes(searchQuery));
                const matchesYear = yearFilter === 'all' || pub.year === yearFilter;
                return matchesSearch && matchesYear;
            });
            renderAll();
        }

        function exportResults() {
            const csv = Papa.unparse(filteredPublications);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'biospace_export.csv';
            a.click();
        }

        // Enhanced AI Functions
        async function analyzeQuestion(question) {
            const lowerQ = question.toLowerCase();
            
            // Extract relevant papers based on keywords in question
            const questionWords = lowerQ.split(' ').filter(w => w.length > 4);
            const relevantPapers = allPublications.filter(pub => {
                return questionWords.some(word => 
                    pub.title.toLowerCase().includes(word) || 
                    pub.keywords.some(kw => kw.includes(word))
                );
            }).slice(0, 5);

            if (relevantPapers.length === 0) {
                return null;
            }

            // Build context from paper titles
            const context = relevantPapers.map((p, i) => 
                `Paper ${i + 1}: ${p.title} (${p.year})`
            ).join('\n');

            return {
                papers: relevantPapers,
                context: context
            };
        }

        async function generateAIAnswer(question, context) {
            try {
                const response = await fetch(`https://api-inference.huggingface.co/models/${HF_QA_MODEL}`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${HF_API_TOKEN}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        inputs: {
                            question: question,
                            context: context
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                return data.answer || null;
            } catch (err) {
                console.error("AI analysis error:", err);
                return null;
            }
        }

        function toggleChatbot() {
            const container = document.getElementById('chatbotContainer');
            container.classList.toggle('active');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addUserMessage(message);
            input.value = '';

            showTypingIndicator();
            
            const response = await generateResponse(message);
            
            hideTypingIndicator();
            addBotMessage(response);
        }

        function addUserMessage(message) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message user';
            messageEl.innerHTML = `
                <div class="message-avatar">👤</div>
                <div class="message-content">${message}</div>
            `;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            chatHistory.push({ role: 'user', message });
        }

        function addBotMessage(message) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message bot';
            messageEl.innerHTML = `
                <div class="message-avatar">🤖</div>
                <div class="message-content">${message}</div>
            `;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            chatHistory.push({ role: 'bot', message });
        }

        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chatMessages');
            const indicator = document.createElement('div');
            indicator.className = 'message bot';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <div class="message-avatar">🤖</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(indicator);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function showQuickActions() {
            const messagesDiv = document.getElementById('chatMessages');
            const actionsEl = document.createElement('div');
            actionsEl.className = 'message bot';
            actionsEl.innerHTML = `
                <div class="message-avatar">🤖</div>
                <div class="message-content">
                    Try these quick actions:
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="quickAction('microgravity')">🔬 Ask about microgravity</button>
                        <button class="quick-action-btn" onclick="quickAction('radiation')">☢️ Ask about radiation</button>
                        <button class="quick-action-btn" onclick="quickAction('recent')">📅 Recent publications</button>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(actionsEl);
        }

        function quickAction(action) {
            const input = document.getElementById('chatInput');
            if (action === 'microgravity') {
                input.value = 'What research has been done on microgravity effects?';
            } else if (action === 'radiation') {
                input.value = 'Tell me about space radiation studies';
            } else if (action === 'recent') {
                input.value = 'What are the most recent publications?';
            }
            sendMessage();
        }

        async function generateResponse(message) {
            const lowerMsg = message.toLowerCase();

            // Check if this is a content-based question
            const isContentQuestion = lowerMsg.includes('what') || lowerMsg.includes('how') || 
                                     lowerMsg.includes('why') || lowerMsg.includes('explain') ||
                                     lowerMsg.includes('tell me about') || lowerMsg.includes('describe');

            // Try AI-powered content analysis for research questions
            if (isContentQuestion && !lowerMsg.includes('how many') && !lowerMsg.includes('how do i')) {
                const analysis = await analyzeQuestion(message);
                
                if (analysis && analysis.papers.length > 0) {
                    const paperList = analysis.papers.map((p, i) => 
                        `<div class="paper-reference"><strong>📄 ${p.title}</strong> (${p.year})<br>Keywords: ${p.keywords.join(', ')}</div>`
                    ).join('');

                    // Extract key insights from titles and keywords
                    const allKeywords = analysis.papers.flatMap(p => p.keywords);
                    const keywordFreq = {};
                    allKeywords.forEach(kw => {
                        keywordFreq[kw] = (keywordFreq[kw] || 0) + 1;
                    });
                    const topKeywords = Object.entries(keywordFreq)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 3)
                        .map(([kw]) => kw);

                    const insight = generateInsightFromPapers(message, analysis.papers, topKeywords);

                    return `🔍 <strong>Based on ${analysis.papers.length} relevant publications:</strong><br><br>
                            ${insight}<br><br>
                            <strong>Key research areas:</strong> ${topKeywords.join(', ')}<br><br>
                            <strong>Relevant Publications:</strong><br>${paperList}`;
                }
            }

            // Statistics queries
            if (lowerMsg.includes('how many') || lowerMsg.includes('total') || lowerMsg.includes('count') || lowerMsg.includes('statistic')) {
                const years = new Set(filteredPublications.map(p => p.year).filter(y => y !== 'Unknown'));
                return `📊 Currently showing <strong>${filteredPublications.length}</strong> publications covering <strong>${years.size}</strong> years. The database contains valuable research from NASA's Space Biology program!`;
            }

            // Year-specific queries
            const yearMatch = lowerMsg.match(/\b(20\d{2})\b/);
            if (yearMatch || lowerMsg.includes('year')) {
                const year = yearMatch ? yearMatch[1] : null;
                if (year) {
                    const yearPubs = allPublications.filter(p => p.year === year);
                    if (yearPubs.length > 0) {
                        const topTopics = extractTopTopics(yearPubs, 3);
                        return `📅 Found <strong>${yearPubs.length}</strong> publications from ${year}.<br><br>
                                <strong>Top research areas that year:</strong> ${topTopics.join(', ')}<br><br>
                                Would you like me to filter the results to show only these publications?`;
                    } else {
                        return `I couldn't find any publications specifically from ${year}. Try browsing other years using the year filter!`;
                    }
                }
            }

            // Topic/keyword queries with enhanced analysis
            if (lowerMsg.includes('topic') || lowerMsg.includes('research area')) {
                const keywordCounts = {};
                filteredPublications.forEach(pub => {
                    pub.keywords.forEach(kw => {
                        keywordCounts[kw] = (keywordCounts[kw] || 0) + 1;
                    });
                });
                const topKeywords = Object.entries(keywordCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
                return `🔬 <strong>Top research topics in the current selection:</strong><br><br>${topKeywords.map(([kw, count]) => `• <strong>${kw}</strong>: ${count} publications`).join('<br>')}<br><br>Ask me specific questions about any of these topics to learn more!`;
            }

            // Search/find queries with AI enhancement
            if (lowerMsg.includes('find') || lowerMsg.includes('search') || lowerMsg.includes('look for')) {
                const searchTerm = lowerMsg.replace(/find|search|look for|publications|about|on|papers/g, '').trim();
                if (searchTerm) {
                    const results = allPublications.filter(p => 
                        p.title.toLowerCase().includes(searchTerm) || 
                        p.keywords.some(kw => kw.includes(searchTerm))
                    );
                    if (results.length > 0) {
                        const recentResults = results.sort((a, b) => b.year.localeCompare(a.year)).slice(0, 3);
                        const paperList = recentResults.map(p => 
                            `<div class="paper-reference"><strong>📄 ${p.title}</strong> (${p.year})</div>`
                        ).join('');
                        return `🔍 I found <strong>${results.length}</strong> publications related to "${searchTerm}".<br><br>
                                <strong>Most recent:</strong><br>${paperList}<br>
                                Use the search box to view all results, or ask me specific questions about this topic!`;
                    } else {
                        const suggestions = getSimilarTopics(searchTerm);
                        return `I couldn't find publications matching "${searchTerm}".<br><br>
                                ${suggestions.length > 0 ? `<strong>Did you mean:</strong> ${suggestions.join(', ')}?` : 'Try related keywords or browse by year!'}`;
                    }
                }
            }

            // Recent publications
            if (lowerMsg.includes('recent') || lowerMsg.includes('latest') || lowerMsg.includes('new')) {
                const sortedByYear = [...allPublications].sort((a, b) => b.year.localeCompare(a.year));
                const recentYear = sortedByYear[0]?.year;
                const recentPubs = allPublications.filter(p => p.year === recentYear).slice(0, 3);
                const topTopics = extractTopTopics(recentPubs, 3);
                const paperList = recentPubs.map(p => 
                    `<div class="paper-reference"><strong>📄 ${p.title}</strong></div>`
                ).join('');
                return `📅 The most recent publications are from <strong>${recentYear}</strong> (${recentPubs.length} total).<br><br>
                        <strong>Emerging research areas:</strong> ${topTopics.join(', ')}<br><br>
                        <strong>Sample publications:</strong><br>${paperList}`;
            }

            // Peak/most productive year
            if (lowerMsg.includes('peak') || lowerMsg.includes('most productive')) {
                const yearCounts = {};
                allPublications.forEach(pub => {
                    if (pub.year !== 'Unknown') {
                        yearCounts[pub.year] = (yearCounts[pub.year] || 0) + 1;
                    }
                });
                const peakYear = Object.entries(yearCounts).sort((a, b) => b[1] - a[1])[0];
                const peakYearPubs = allPublications.filter(p => p.year === peakYear[0]);
                const topTopics = extractTopTopics(peakYearPubs, 3);
                return `📈 The most productive year was <strong>${peakYear[0]}</strong> with <strong>${peakYear[1]}</strong> publications!<br><br>
                        <strong>Major research focuses that year:</strong> ${topTopics.join(', ')}`;
            }

            // Compare topics
            if (lowerMsg.includes('compare') || lowerMsg.includes('versus') || lowerMsg.includes('vs')) {
                return `📊 To compare topics, try asking: "What research exists on [topic A]?" and then "What about [topic B]?" I'll help you identify the differences and similarities!`;
            }

            // Trends over time
            if (lowerMsg.includes('trend') || lowerMsg.includes('over time') || lowerMsg.includes('evolution')) {
                const yearCounts = {};
                allPublications.forEach(pub => {
                    if (pub.year !== 'Unknown') {
                        yearCounts[pub.year] = (yearCounts[pub.year] || 0) + 1;
                    }
                });
                const years = Object.keys(yearCounts).sort();
                const recentYears = years.slice(-5);
                const recentCounts = recentYears.map(y => yearCounts[y]);
                const trend = recentCounts[recentCounts.length - 1] > recentCounts[0] ? 'increasing' : 'decreasing';
                return `📈 <strong>Publication trends:</strong><br><br>
                        The number of publications is <strong>${trend}</strong> in recent years.<br>
                        Last 5 years: ${recentYears.map((y, i) => `${y} (${recentCounts[i]})`).join(', ')}<br><br>
                        Ask about specific research topics to see how they've evolved!`;
            }

            // Export help
            if (lowerMsg.includes('export') || lowerMsg.includes('download') || lowerMsg.includes('save')) {
                return `💾 You can export the current filtered results by clicking the "Export Results" button at the top of the page. This will download a CSV file with all the publications!`;
            }

            // Help/capabilities
            if (lowerMsg.includes('help') || lowerMsg.includes('what can you') || lowerMsg.includes('how do')) {
                return `🤖 <strong>I can help you:</strong><br><br>
                        • Answer questions about research topics (e.g., "What studies exist on microgravity?")<br>
                        • Analyze publication trends over time<br>
                        • Find papers by year, topic, or keyword<br>
                        • Compare research areas<br>
                        • Show statistics and insights<br>
                        • Identify emerging research themes<br><br>
                        Just ask me anything about the NASA Space Biology publications!`;
            }

            // Filter help
            if (lowerMsg.includes('filter') || lowerMsg.includes('narrow')) {
                return `🎯 <strong>To filter publications:</strong><br><br>
                        • Use the <strong>search box</strong> to find specific topics or keywords<br>
                        • Use the <strong>year dropdown</strong> to filter by publication year<br>
                        • Combine both filters for precise results<br>
                        • Press <strong>Ctrl+K</strong> to quickly focus the search box!<br><br>
                        Or just ask me to find something, and I'll help!`;
            }

            // Greeting responses
            if (lowerMsg.includes('hello') || lowerMsg.includes('hi') || lowerMsg.includes('hey')) {
                return `👋 Hello! I'm here to help you explore NASA Space Biology publications with AI-powered insights. Ask me anything about the research!`;
            }

            if (lowerMsg.includes('thank') || lowerMsg.includes('thanks')) {
                return `You're welcome! Feel free to ask me anything else about the publications! 😊`;
            }

            // Default response with AI context
            return `I'm here to help! Try asking me:<br><br>
                    • 🔬 <strong>Research questions:</strong> "What studies have been done on [topic]?"<br>
                    • 📊 <strong>Data analysis:</strong> "Show me publication trends"<br>
                    • 🔍 <strong>Finding papers:</strong> "Find research about [keyword]"<br>
                    • 📈 <strong>Insights:</strong> "What are emerging research areas?"<br><br>
                    I can analyze the content and help you understand the research!`;
        }

        function generateInsightFromPapers(question, papers, topKeywords) {
            const lowerQ = question.toLowerCase();
            const years = [...new Set(papers.map(p => p.year))].sort();
            const yearRange = years.length > 1 ? `${years[0]} to ${years[years.length - 1]}` : years[0];

            if (lowerQ.includes('microgravity')) {
                return `Research on microgravity effects spans ${yearRange} with ${papers.length} relevant publications. Studies focus on ${topKeywords.join(', ')} and their implications for space biology.`;
            } else if (lowerQ.includes('radiation')) {
                return `Space radiation research from ${yearRange} includes ${papers.length} publications examining ${topKeywords.join(', ')} and biological responses to space environment.`;
            } else if (lowerQ.includes('muscle') || lowerQ.includes('bone')) {
                return `Musculoskeletal research in space (${yearRange}) covers ${papers.length} studies on ${topKeywords.join(', ')}, critical for long-duration spaceflight.`;
            } else if (lowerQ.includes('plant') || lowerQ.includes('growth')) {
                return `Plant biology research spans ${yearRange} with ${papers.length} publications on ${topKeywords.join(', ')}, essential for life support systems.`;
            } else if (lowerQ.includes('cell') || lowerQ.includes('molecular')) {
                return `Cellular and molecular studies (${yearRange}) include ${papers.length} papers investigating ${topKeywords.join(', ')} at the fundamental level.`;
            } else {
                return `Found ${papers.length} relevant publications from ${yearRange} focusing on ${topKeywords.join(', ')}. These studies contribute to our understanding of biological systems in space environments.`;
            }
        }

        function extractTopTopics(papers, limit = 3) {
            const keywordCounts = {};
            papers.forEach(pub => {
                pub.keywords.forEach(kw => {
                    keywordCounts[kw] = (keywordCounts[kw] || 0) + 1;
                });
            });
            return Object.entries(keywordCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit)
                .map(([kw]) => kw);
        }

        function getSimilarTopics(searchTerm) {
            const allKeywords = [...new Set(allPublications.flatMap(p => p.keywords))];
            return allKeywords
                .filter(kw => kw.includes(searchTerm.substring(0, 4)) || 
                             searchTerm.includes(kw.substring(0, 4)))
                .slice(0, 3);
        }

        console.log('🚀 BioSpace Explorer with Enhanced AI Chatbot Ready!');
        console.log('💬 The chatbot can now analyze paper content and answer research questions!');
    </script>
    
</body>
</html>
